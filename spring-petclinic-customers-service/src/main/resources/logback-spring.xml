<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- Include default Spring Boot logging configuration -->
    <include resource="org/springframework/boot/logging/logback/base.xml"/>

    <springProperty scope="context" name="appName" source="spring.application.name"/>

    <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
        <http>
            <url>http://loki:3100/loki/api/v1/push</url>
            <connectTimeoutMs>1000</connectTimeoutMs>
            <readTimeoutMs>5000</readTimeoutMs>
        </http>
        <encoder class="com.github.loki4j.logback.JsonEncoder">
            <labels>
                app=${appName}, level=%level
            </labels>
            <timestampPattern>yyyy-MM-dd'T'HH:mm:ss.SSS</timestampPattern>
            <customFields>{"traceId":"%X{traceId}","spanId":"%X{spanId}"}</customFields>
        </encoder>
    </appender>

    <!-- Console Appender (for local viewing/debugging) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg [traceId=%X{traceId}, spanId=%X{spanId}]%n</pattern>
        </encoder>
    </appender>

    <!-- Root Logger -->
    <root level="INFO">
        <appender-ref ref="LOKI"/>
        <appender-ref ref="CONSOLE"/>
    </root>

    <!-- Enable dynamic config update via JMX -->
    <jmxConfigurator/>

</configuration>
